<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Scan Absen Kegiatan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.card{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:10px}
label{font-weight:bold;display:block;margin-top:10px}
select,input,button{width:100%;padding:8px;margin-top:6px}
button{border:none;color:white;cursor:pointer}
.btn-scan{background:#2e7d32}
.btn-manual{background:#f57c00;margin-top:8px}
.tabs{display:flex;gap:8px;margin-top:15px}
.tab{flex:1;background:#90caf9}
.tab.active{background:#1565c0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
.notice{margin-top:10px;padding:8px;border-radius:6px;display:none}
.success{background:#e8f5e9;color:#2e7d32}
.error{background:#ffebee;color:#c62828}
#reader{margin-top:10px}
.modal{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.5)
}
.modal-content{
  background:#fff;padding:20px;max-width:400px;
  margin:10% auto;border-radius:10px
}
.list-check label{display:block}
</style>
</head>
<body>

<div class="card">
<h2 align="center">Scan Absen Kegiatan</h2>

<label>Lembaga</label>
<select id="lembaga"></select>

<label>Kegiatan</label>
<select id="kegiatan"></select>

<label>Tanggal</label>
<input type="date" id="tanggal">

<button class="btn-scan" onclick="startScan()">üì∑ Scan Barcode</button>
<button class="btn-manual" onclick="bukaManual()">‚úçÔ∏è Input Manual</button>

<div id="reader"></div>
<div id="notif" class="notice"></div>

<div class="tabs">
  <button class="tab" onclick="showHadir()">Hadir</button>
  <button class="tab" onclick="showTidakHadir()">Tidak Hadir</button>
  <button class="tab active" onclick="showNilai()">Nilai</button>
</div>

<table>
<thead id="thead"></thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- MODAL INPUT MANUAL -->
<div class="modal" id="modalManual">
  <div class="modal-content">
    <h3>Input Manual</h3>
    <div id="listManual" class="list-check"></div>
    <button onclick="simpanManual()">Simpan</button>
    <button onclick="tutupManual()" style="background:#9e9e9e;margin-top:6px">Batal</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain:"datasiswa-c10f4.firebaseapp.com",
  projectId:"datasiswa-c10f4"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const lembagaEl=document.getElementById("lembaga");
const kegiatanEl=document.getElementById("kegiatan");
const tanggalEl=document.getElementById("tanggal");
const notifEl=document.getElementById("notif");
const thead=document.getElementById("thead");
const tbody=document.getElementById("tbody");
const modal=document.getElementById("modalManual");
const listManual=document.getElementById("listManual");

let peserta=[], hadir=[], scanner, unlock=false;

/* tanggal + password */
tanggalEl.value=new Date().toLocaleDateString("en-CA");
tanggalEl.addEventListener("click",()=>{
  if(!unlock){
    if(prompt("Password tanggal")==="123"){
      unlock=true; showNotif("Tanggal dibuka","success");
    }else{
      showNotif("Password salah","error");
      tanggalEl.blur();
    }
  }
});

/* load lembaga */
const loadLembaga=async()=>{
  const s=await getDocs(collection(db,"lembaga"));
  s.forEach(d=>lembagaEl.innerHTML+=`<option value="${d.id}">${d.data().nama}</option>`);
};
loadLembaga();

/* load kegiatan */
lembagaEl.addEventListener("change",async()=>{
  kegiatanEl.innerHTML="";
  const q=query(collection(db,"kegiatan"),where("lembagaId","==",lembagaEl.value));
  const s=await getDocs(q);
  s.forEach(d=>kegiatanEl.innerHTML+=`<option value="${d.id}">${d.data().namaKegiatan}</option>`);
});

/* load peserta */
kegiatanEl.addEventListener("change",async()=>{
  hadir=[];
  peserta=[];
  const q=query(collection(db,"peserta_kegiatan"),where("kegiatanId","==",kegiatanEl.value));
  const s=await getDocs(q);
  s.forEach(d=>peserta.push(d.data().namaPeserta));
  showNilai();
});

/* SCAN */
window.startScan=async()=>{
  scanner=new Html5Qrcode("reader");
  await scanner.start({facingMode:"environment"},{fps:10,qrbox:250},onScan);
};

function onScan(text){
  if(text[0]!=="|"){showNotif("Silakan scan barcode siswa","error");return;}
  tambahHadir(text.substring(1).trim());
}

/* INPUT MANUAL */
window.bukaManual=()=>{
  if(prompt("Password input manual")!=="123"){
    showNotif("Password salah","error"); return;
  }
  listManual.innerHTML=peserta.map(n=>`
    <label><input type="checkbox" value="${n}"> ${n}</label>
  `).join("");
  modal.style.display="block";
};

window.tutupManual=()=>modal.style.display="none";

window.simpanManual=()=>{
  document.querySelectorAll("#listManual input:checked")
    .forEach(cb=>tambahHadir(cb.value));
  modal.style.display="none";
};

/* TAMBAH HADIR */
function tambahHadir(nama){
  if(!hadir.includes(nama)){
    hadir.push(nama);
    showNotif("Hadir: "+nama,"success");
  }
  showNilai();
}

/* TAB */
window.showHadir=()=>{
  setActive(0);
  thead.innerHTML="<tr><th>No</th><th>Nama</th></tr>";
  tbody.innerHTML=hadir.map((n,i)=>`<tr><td>${i+1}</td><td>${n}</td></tr>`).join("");
};
window.showTidakHadir=()=>{
  setActive(1);
  const th=peserta.filter(n=>!hadir.includes(n));
  thead.innerHTML="<tr><th>No</th><th>Nama</th></tr>";
  tbody.innerHTML=th.map((n,i)=>`<tr><td>${i+1}</td><td>${n}</td></tr>`).join("");
};
window.showNilai=()=>{
  setActive(2);
  thead.innerHTML="<tr><th>No</th><th>Nama</th><th>Nilai</th></tr>";
  tbody.innerHTML=peserta.map((n,i)=>`
    <tr><td>${i+1}</td><td>${n}</td><td>${hadir.includes(n)?5:0}</td></tr>
  `).join("");
};
function setActive(i){
  document.querySelectorAll(".tab").forEach((b,idx)=>b.classList.toggle("active",idx===i));
}

/* notif */
function showNotif(msg,type){
  notifEl.textContent=msg;
  notifEl.className="notice "+type;
  notifEl.style.display="block";
  setTimeout(()=>notifEl.style.display="none",2000);
}
</script>

</body>
</html>
