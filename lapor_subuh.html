<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Lapor Subuh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 40px;
      background: #f4f6f8;
    }
    #jam {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 16px;
    }
    #btnSubuh {
      padding: 18px 40px;
      font-size: 20px;
      color: white;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      background-color: red;
      transition: 0.3s;
    }
    #info { margin-top: 16px; font-size: 16px; }
    #countdown { margin-top: 10px; font-size: 15px; }

    #formLapor {
      margin-top: 30px;
      padding: 20px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      display: none;
    }

    select, button, input[type="file"] {
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      width: 80%;
      max-width: 300px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    #btnKirim {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }

    #preview, #fotoSukses {
      width: 180px;
      margin: 10px auto;
      display: none;
      border-radius: 12px;
    }

    #terimakasih {
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      display: none;
      color: green;
    }

    #loading {
      display: none;
      font-size: 14px;
      margin-top: 8px;
      color: #666;
    }
  </style>
</head>
<body>

<div id="jam">--:--:--</div>
<button id="btnSubuh">Lapor Subuh</button>
<div id="info"></div>
<div id="countdown"></div>

<!-- FORM -->
<div id="formLapor">
  <select id="kelas">
    <option value="">Pilih Kelas</option>
    <option value="1">Kelas 1</option>
    <option value="2">Kelas 2</option>
    <option value="3">Kelas 3</option>
    <option value="4">Kelas 4</option>
    <option value="5">Kelas 5</option>
    <option value="6">Kelas 6</option>
  </select>

  <div id="loading">Memuat nama siswa...</div>

  <select id="nama" style="display:none;">
    <option value="">Pilih Nama</option>
  </select>

  <input type="file" id="foto" accept="image/*" style="display:none;">
  <img id="preview">

  <button id="btnKirim" style="display:none;">Kirim</button>
</div>

<!-- HASIL -->
<img id="fotoSukses">
<div id="terimakasih"></div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwoU1qINJ-JjNpWayXFzY7VSkzrAOmdLzqz2CBvM1l8d5VPhaOqVHN4r-ksI3DoJKWLMA/exec";

  const btn = document.getElementById("btnSubuh");
  const info = document.getElementById("info");
  const jamDiv = document.getElementById("jam");

  const formLapor = document.getElementById("formLapor");
  const selectKelas = document.getElementById("kelas");
  const selectNama = document.getElementById("nama");
  const btnKirim = document.getElementById("btnKirim");
  const inputFoto = document.getElementById("foto");
  const preview = document.getElementById("preview");
  const loadingDiv = document.getElementById("loading");

  const fotoSukses = document.getElementById("fotoSukses");
  const terimakasih = document.getElementById("terimakasih");

  let sudahKirim = false;
  let dataSiswa = {};

  function pad(n){ return n.toString().padStart(2,'0'); }

  function updateWaktu() {
    const sekarang = new Date();
    const jam = sekarang.getHours();
    const menit = sekarang.getMinutes();
    const detik = sekarang.getSeconds();
    const totalMenit = jam * 60 + menit;

    jamDiv.textContent = `Waktu sekarang: ${pad(jam)}:${pad(menit)}:${pad(detik)}`;

    const mulai = 11 * 60;   // 03.00
    const selesai = 13 * 60; // 05.00
    const dalamRentang = (totalMenit >= mulai && totalMenit <= selesai);

    if (dalamRentang) {
      if (sudahKirim) return;
      btn.style.backgroundColor = "blue";
      info.textContent = "✅ Lapor Subuh sedang dibuka";
      formLapor.style.display = "block";
    } else {
      btn.style.backgroundColor = "red";
      info.textContent = "⏰ Lapor Subuh aktif pukul 03.00 – 05.00";
      if (!sudahKirim) formLapor.style.display = "none";
    }
  }

  // Ambil data dari Spreadsheet
  function ambilDataSiswa() {
    loadingDiv.style.display = "block";
    fetch(API_URL)
      .then(response => response.json())
      .then(data => {
        dataSiswa = data;
        loadingDiv.style.display = "none";
      })
      .catch(err => {
        console.error("Gagal memuat data:", err);
        loadingDiv.textContent = "❌ Gagal memuat data";
      });
  }

  // Saat pilih kelas
  selectKelas.addEventListener("change", function() {
    const kelas = this.value;

    selectNama.style.display = "none";
    inputFoto.style.display = "none";
    btnKirim.style.display = "none";
    preview.style.display = "none";

    if (!kelas) return;

    if (!dataSiswa[kelas]) {
      alert("Data siswa belum dimuat. Tunggu sebentar...");
      return;
    }

    selectNama.innerHTML = '<option value="">Pilih Nama</option>';
    dataSiswa[kelas].forEach(nama => {
      selectNama.innerHTML += `<option value="${nama}">${nama}</option>`;
    });

    selectNama.style.display = "block";
  });

  // Saat pilih nama
  selectNama.addEventListener("change", function() {
    if (this.value !== "") {
      inputFoto.style.display = "block";
      btnKirim.style.display = "none";
    }
  });

  // Preview foto
  inputFoto.addEventListener("change", function() {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = "block";
      btnKirim.style.display = "block";
    };
    reader.readAsDataURL(file);
  });

  // Kirim laporan
  
btnKirim.addEventListener("click", function() {
  const nama = selectNama.value;
  const kelas = selectKelas.value;
  const fotoBase64 = preview.src;

  if (!nama || !kelas || !fotoBase64) {
    alert("Lengkapi data terlebih dahulu");
    return;
  }

  btnKirim.textContent = "Mengirim...";
  btnKirim.disabled = true;

  const data = {
    nama: nama,
    kelas: kelas,
    foto: fotoBase64
  };

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    if (res.status === "sukses") {
      sudahKirim = true;
      formLapor.style.display = "none";

      fotoSukses.src = fotoBase64;
      fotoSukses.style.display = "block";

      terimakasih.textContent = `✅ Terima kasih ${nama}, laporan terkirim`;
      terimakasih.style.display = "block";
    } else {
      alert("Gagal: " + res.pesan);
    }

    btnKirim.textContent = "Kirim";
    btnKirim.disabled = false;
  })
  .catch(err => {
    alert("Gagal mengirim data");
    console.error(err);
    btnKirim.textContent = "Kirim";
    btnKirim.disabled = false;
  });
});


  // Jalankan
  ambilDataSiswa();
  updateWaktu();
  setInterval(updateWaktu, 1000);
</script>

</body>
</html>
