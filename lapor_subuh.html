<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Lapor Subuh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 40px;
      background: #f4f6f8;
    }
    #jam {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 16px;
    }
    #btnSubuh {
      padding: 18px 40px;
      font-size: 20px;
      color: white;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      background-color: red;
      transition: 0.3s;
    }
    #info { margin-top: 16px; font-size: 16px; }

    #formLapor {
      margin-top: 30px;
      padding: 20px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      display: none;
    }

    select, button, input[type="file"] {
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      width: 80%;
      max-width: 300px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    #btnKirim {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }

    #preview, #fotoSukses {
      width: 180px;
      margin: 10px auto;
      display: none;
      border-radius: 12px;
    }

    #terimakasih {
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      display: none;
      color: green;
    }

    #loading {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<div id="jam">--:--:--</div>
<button id="btnSubuh">Lapor Subuh</button>
<div id="info"></div>
 <div id="loading">Memuat data siswa...</div>
<div id="statusData" style="font-size:14px;color:green;margin-top:4px;"></div>


<!-- FORM -->
<div id="formLapor">
  <select id="kelas" disabled>
    <option value="">Pilih kelas</option>
    <option value="1">Kelas 1</option>
    <option value="2">Kelas 2</option>
    <option value="3">Kelas 3</option>
    <option value="4">Kelas 4</option>
    <option value="5">Kelas 5</option>
    <option value="6">Kelas 6</option>
  </select>

 

  <select id="nama" style="display:none;">
    <option value="">Pilih Nama</option>
  </select>

  <input type="file" id="foto" accept="image/*" style="display:none;">
  <img id="preview">

  <button id="btnKirim" style="display:none;">Kirim</button>
</div>

<!-- HASIL -->
<img id="fotoSukses">
<div id="terimakasih"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwoU1qINJ-JjNpWayXFzY7VSkzrAOmdLzqz2CBvM1l8d5VPhaOqVHN4r-ksI3DoJKWLMA/exec";

const btn = document.getElementById("btnSubuh");
const info = document.getElementById("info");
const jamDiv = document.getElementById("jam");

const formLapor = document.getElementById("formLapor");
const selectKelas = document.getElementById("kelas");
const selectNama = document.getElementById("nama");
const btnKirim = document.getElementById("btnKirim");
const inputFoto = document.getElementById("foto");
const preview = document.getElementById("preview");
const loadingDiv = document.getElementById("loading");

const fotoSukses = document.getElementById("fotoSukses");
const terimakasih = document.getElementById("terimakasih");

const statusData = document.getElementById("statusData");


let sudahKirim = false;
let dataSiswa = {};

function pad(n){ return n.toString().padStart(2,'0'); }



// Waktu aktif
function updateWaktu() {
  const sekarang = new Date();
  const jam = sekarang.getHours();
  const menit = sekarang.getMinutes();
  const detik = sekarang.getSeconds();
  const totalMenit = jam * 60 + menit;

  jamDiv.textContent = `Waktu sekarang: ${pad(jam)}:${pad(menit)}:${pad(detik)}`;

  const mulai = 7 * 60;
  const selesai = 23 * 60;
  const dalamRentang = (totalMenit >= mulai && totalMenit <= selesai);

  if (dalamRentang) {
    if (sudahKirim) return;
    btn.style.backgroundColor = "blue";
    info.textContent = "✅ Lapor Subuh sedang dibuka";
    formLapor.style.display = "block";
  } else {
    btn.style.backgroundColor = "red";
    info.textContent = "⏰ Lapor Subuh aktif pukul 03.00 – 05.00";
    if (!sudahKirim) formLapor.style.display = "none";
  }
}

// Kompres foto (30KB)
function compressImage(file, targetSizeKB = 30, maxWidth = 800) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    const img = new Image();

    reader.onload = function(e) {
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);

    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      let width = img.width;
      let height = img.height;

      if (width > maxWidth) {
        height = Math.round((height * maxWidth) / width);
        width = maxWidth;
      }

      canvas.width = width;
      canvas.height = height;

      ctx.drawImage(img, 0, 0, width, height);

      let quality = 0.9;
      let base64 = canvas.toDataURL('image/jpeg', quality);

      while (base64.length / 1024 > targetSizeKB && quality > 0.1) {
        quality -= 0.05;
        base64 = canvas.toDataURL('image/jpeg', quality);
      }

      resolve(base64);
    };
  });
}

// Ambil data siswa
function ambilDataSiswa() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      dataSiswa = data;

      // ✅ HILANGKAN tulisan "Memuat..."
      loadingDiv.style.display = "none";

      // ✅ Tampilkan status "Data siap"
      statusData.textContent = "✅ Data siap";

      // Aktifkan dropdown kelas
      selectKelas.disabled = false;
    })
    .catch(err => {
      statusData.textContent = "❌ Gagal memuat data";
      console.error(err);
    });
}


// Pilih kelas
selectKelas.addEventListener("change", function() {
  const kelas = this.value;

  selectNama.style.display = "none";
  inputFoto.style.display = "none";
  btnKirim.style.display = "none";
  preview.style.display = "none";

  if (!kelas) return;

  if (!dataSiswa[kelas]) {
    alert("Data siswa belum tersedia");
    return;
  }

  selectNama.innerHTML = '<option value="">Pilih Nama</option>';
  dataSiswa[kelas].forEach(nama => {
    selectNama.innerHTML += `<option value="${nama}">${nama}</option>`;
  });

  selectNama.style.display = "block";
});

// Pilih nama → tampil upload + kirim
selectNama.addEventListener("change", function() {
  if (this.value !== "") {
    inputFoto.style.display = "block";
    btnKirim.style.display = "block";
  } else {
    inputFoto.style.display = "none";
    btnKirim.style.display = "none";
  }
});

// Upload foto (opsional)
inputFoto.addEventListener("change", async function() {
  const file = this.files[0];
  if (!file) {
    preview.style.display = "none";
    return;
  }

  const compressed = await compressImage(file, 30);
  preview.src = compressed;
  preview.style.display = "block";
});

// Kirim
btnKirim.addEventListener("click", function() {
  const nama = selectNama.value;
  const kelas = selectKelas.value;

  let foto = "";
  if (preview.src && preview.src.startsWith("data:image")) {
    foto = preview.src;
  }

  if (!nama || !kelas) {
    alert("Pilih kelas dan nama");
    return;
  }

  btnKirim.textContent = "Mengirim...";
  btnKirim.disabled = true;

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ nama, kelas, foto })
  })
  .then(res => res.json())
  .then(res => {
    if (res.status === "sukses") {
      sudahKirim = true;
      formLapor.style.display = "none";

      if (foto !== "") {
        fotoSukses.src = foto;
        fotoSukses.style.display = "block";
      }

      terimakasih.textContent = `✅ Terima kasih ${nama}, laporan terkirim`;
      terimakasih.style.display = "block";
    } else {
      alert("Gagal: " + res.pesan);
    }

    btnKirim.textContent = "Kirim";
    btnKirim.disabled = false;
  })
  .catch(err => {
    alert("Gagal mengirim");
    console.error(err);
    btnKirim.textContent = "Kirim";
    btnKirim.disabled = false;
  });
});

// Jalankan
ambilDataSiswa();
updateWaktu();
setInterval(updateWaktu, 1000);
</script>

</body>
</html>
